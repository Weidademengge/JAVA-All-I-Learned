对象内部的组成结构
![[Pasted image 20230214100930.png]]
![[Pasted image 20230227163326.png]]


## 代码分析
为了能够看见对象中内部结构，引入依赖
``` java
<dependency>  
  <groupId>org.openjdk.jol</groupId>  
  <artifactId>jol-core</artifactId>  
  <version>0.10</version>  
</dependency>
```

打印user对象内部结构
```java
package com.bilibili.lock;  
  
import com.bilibili.vo.User;  
import org.openjdk.jol.info.ClassLayout;  
  
import static java.lang.Thread.sleep;  
  
/**  
 * @author 杜雨萌  
 * @version $ Id: LockUpgrade, v 0.1 2023/02/27 16:34 banma-0163 Exp $  
 */public class LockUpgrade {  
  
    public static void main(String[] args) throws InterruptedException {  
        User userTemp = new User();  
        System.out.println("无状态（001）："+ ClassLayout.parseInstance(userTemp).toPrintable());  
  
        /**  
         * JVM默认延时4s自动开启偏向锁，可通过-XX:BiasedLockingStartupDelay=0 取消延时  
         * 如果不要偏向锁，可通过-XX:-UseBiasedLocking=false来设置  
         */  
        sleep(5000);  
        User user = new User();  
        System.out.println("启用偏向锁（101）："+ClassLayout.parseInstance(user).toPrintable());  
  
        for(int i = 0;i<2;i++){  
            synchronized (user){  
                System.out.println("偏向锁（101）带线程id：" + ClassLayout.parseInstance(user).toPrintable());  
            }  
            System.out.println("偏向锁（101）带线程id的：" + ClassLayout.parseInstance(user).toPrintable());  
        }  
  
        new Thread(()->{  
            synchronized (user){  
                System.out.print("轻量级锁（00）："+ClassLayout.parseInstance(user).toPrintable());  
                try {  
                    System.out.println("睡眠3秒钟==============");  
                    Thread.sleep(3000);  
                }catch (InterruptedException e){  
                    e.printStackTrace();  
                }  
                System.out.println("轻量--> 重量（10）:" + ClassLayout.parseInstance(user).toPrintable());  
            }  
        }).start();  
  
        Thread.sleep(1000);  
        new Thread(()->{  
            synchronized (user){  
                System.out.println("重量级锁（10）："+ClassLayout.parseInstance(user).toPrintable());  
            }  
        }).start();  
  
    }  
}
```

得到的结果：
```java
com.bilibili.lock.LockUpgrade
无状态（001）：com.bilibili.vo.User object internals:
 OFFSET  SIZE               TYPE DESCRIPTION                               VALUE
      0     4                    (object header)                           01 00 00 00 (00000001 00000000 00000000 00000000) (1)
      4     4                    (object header)                           00 00 00 00 (00000000 00000000 00000000 00000000) (0)
      8     4                    (object header)                           43 c1 00 20 (01000011 11000001 00000000 00100000) (536920387)
     12     4                int User.id                                   0
     16     4   java.lang.String User.name                                 null
     20     4                    (loss due to the next object alignment)
Instance size: 24 bytes
Space losses: 0 bytes internal + 4 bytes external = 4 bytes total

启用偏向锁（101）：com.bilibili.vo.User object internals:
 OFFSET  SIZE               TYPE DESCRIPTION                               VALUE
      0     4                    (object header)                           05 00 00 00 (00000101 00000000 00000000 00000000) (5)
      4     4                    (object header)                           00 00 00 00 (00000000 00000000 00000000 00000000) (0)
      8     4                    (object header)                           43 c1 00 20 (01000011 11000001 00000000 00100000) (536920387)
     12     4                int User.id                                   0
     16     4   java.lang.String User.name                                 null
     20     4                    (loss due to the next object alignment)
Instance size: 24 bytes
Space losses: 0 bytes internal + 4 bytes external = 4 bytes total

偏向锁（101）带线程id：com.bilibili.vo.User object internals:
 OFFSET  SIZE               TYPE DESCRIPTION                               VALUE
      0     4                    (object header)                           05 e8 3a 03 (00000101 11101000 00111010 00000011) (54192133)
      4     4                    (object header)                           00 00 00 00 (00000000 00000000 00000000 00000000) (0)
      8     4                    (object header)                           43 c1 00 20 (01000011 11000001 00000000 00100000) (536920387)
     12     4                int User.id                                   0
     16     4   java.lang.String User.name                                 null
     20     4                    (loss due to the next object alignment)
Instance size: 24 bytes
Space losses: 0 bytes internal + 4 bytes external = 4 bytes total

偏向锁（101）带线程id的：com.bilibili.vo.User object internals:
 OFFSET  SIZE               TYPE DESCRIPTION                               VALUE
      0     4                    (object header)                           05 e8 3a 03 (00000101 11101000 00111010 00000011) (54192133)
      4     4                    (object header)                           00 00 00 00 (00000000 00000000 00000000 00000000) (0)
      8     4                    (object header)                           43 c1 00 20 (01000011 11000001 00000000 00100000) (536920387)
     12     4                int User.id                                   0
     16     4   java.lang.String User.name                                 null
     20     4                    (loss due to the next object alignment)
Instance size: 24 bytes
Space losses: 0 bytes internal + 4 bytes external = 4 bytes total

偏向锁（101）带线程id：com.bilibili.vo.User object internals:
 OFFSET  SIZE               TYPE DESCRIPTION                               VALUE
      0     4                    (object header)                           05 e8 3a 03 (00000101 11101000 00111010 00000011) (54192133)
      4     4                    (object header)                           00 00 00 00 (00000000 00000000 00000000 00000000) (0)
      8     4                    (object header)                           43 c1 00 20 (01000011 11000001 00000000 00100000) (536920387)
     12     4                int User.id                                   0
     16     4   java.lang.String User.name                                 null
     20     4                    (loss due to the next object alignment)
Instance size: 24 bytes
Space losses: 0 bytes internal + 4 bytes external = 4 bytes total

偏向锁（101）带线程id的：com.bilibili.vo.User object internals:
 OFFSET  SIZE               TYPE DESCRIPTION                               VALUE
      0     4                    (object header)                           05 e8 3a 03 (00000101 11101000 00111010 00000011) (54192133)
      4     4                    (object header)                           00 00 00 00 (00000000 00000000 00000000 00000000) (0)
      8     4                    (object header)                           43 c1 00 20 (01000011 11000001 00000000 00100000) (536920387)
     12     4                int User.id                                   0
     16     4   java.lang.String User.name                                 null
     20     4                    (loss due to the next object alignment)
Instance size: 24 bytes
Space losses: 0 bytes internal + 4 bytes external = 4 bytes total

轻量级锁（00）：com.bilibili.vo.User object internals:
 OFFSET  SIZE               TYPE DESCRIPTION                               VALUE
      0     4                    (object header)                           c8 f5 b1 1b (11001000 11110101 10110001 00011011) (464647624)
      4     4                    (object header)                           00 00 00 00 (00000000 00000000 00000000 00000000) (0)
      8     4                    (object header)                           43 c1 00 20 (01000011 11000001 00000000 00100000) (536920387)
     12     4                int User.id                                   0
     16     4   java.lang.String User.name                                 null
     20     4                    (loss due to the next object alignment)
Instance size: 24 bytes
Space losses: 0 bytes internal + 4 bytes external = 4 bytes total
睡眠3秒钟==============
轻量--> 重量（10）:com.bilibili.vo.User object internals:
 OFFSET  SIZE               TYPE DESCRIPTION                               VALUE
      0     4                    (object header)                           ea ee 4e 18 (11101010 11101110 01001110 00011000) (407826154)
      4     4                    (object header)                           00 00 00 00 (00000000 00000000 00000000 00000000) (0)
      8     4                    (object header)                           43 c1 00 20 (01000011 11000001 00000000 00100000) (536920387)
     12     4                int User.id                                   0
     16     4   java.lang.String User.name                                 null
     20     4                    (loss due to the next object alignment)
Instance size: 24 bytes
Space losses: 0 bytes internal + 4 bytes external = 4 bytes total

重量级锁（10）：com.bilibili.vo.User object internals:
 OFFSET  SIZE               TYPE DESCRIPTION                               VALUE
      0     4                    (object header)                           ea ee 4e 18 (11101010 11101110 01001110 00011000) (407826154)
      4     4                    (object header)                           00 00 00 00 (00000000 00000000 00000000 00000000) (0)
      8     4                    (object header)                           43 c1 00 20 (01000011 11000001 00000000 00100000) (536920387)
     12     4                int User.id                                   0
     16     4   java.lang.String User.name                                 null
     20     4                    (loss due to the next object alignment)
Instance size: 24 bytes
Space losses: 0 bytes internal + 4 bytes external = 4 bytes total


Process finished with exit code 0

       
```

前两行对应mark Word


