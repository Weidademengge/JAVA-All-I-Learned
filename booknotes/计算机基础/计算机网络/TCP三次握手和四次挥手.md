## 1.TCP报文格式
![[Pasted image 20230212193547.png]]

其中URG、ACK、PSH、RST、SYN、FIN表示标志位

这里三次握手和四次挥手只用到ACK、SYN、FIN三个标志位：

- ACK：表示前面的确认号字段是否有效。ACK=1 时表示有效。只有当 ACK=1 时，前面的确认号字段才有效。TCP 规定，连接建立后，ACK 必须为 1
	- 理解：ACK 必须为 1，表示TCP 确认号（Acknowledgment Number，ACK Number）有效
- SYN：在建立连接时使用，用来同步序号。

    - 当 SYN=1，ACK=0 时，表示这是一个请求建立连接的报文段；
    - 当 SYN=1，ACK=1 时，表示对方同意建立连接。
    - SYN=1 时，说明这是一个请求建立连接或同意建立连接的报文。只有在前两次握手中 SYN 才为 1。
- FIN：标记数据是否发送完毕。如果 FIN=1，表示数据已经发送完成，可以释放连接。

![[Pasted image 20230212195350.png]]

**第一次握手**

客户端向服务端发送连接请求报文段。该报文段的头部中SYN=1，ACK=0，seq=x。请求发送后，客户端便进入SYN-SENT状态。

-   PS1：SYN=1，ACK=0表示该报文段为连接请求报文。
    
-   PS2：x为本次TCP通信的字节流的初始序号。TCP规定：SYN=1的报文段不能有数据部分，但要消耗掉一个序号。
    

**第二次握手**

服务端收到连接请求报文段后，如果同意连接，则会发送一个应答：SYN=1，ACK=1，seq=y，ack=x+1。该应答发送完成后便进入SYN-RCVD状态。

-   PS1：SYN=1，ACK=1表示该报文段为连接同意的应答报文。
    
-   PS2：seq=y表示服务端作为发送者时，发送字节流的初始序号。
    
-   PS3：ack=x+1表示服务端希望下一个数据报发送序号从x+1开始的字节。
    

**第三次握手**

当客户端收到连接同意的应答后，还要向服务端发送一个确认报文段，表示：服务端发来的连接同意应答已经成功收到。该报文段的头部为：ACK=1，seq=x+1，ack=y+1。客户端发完这个报文段后便进入ESTABLISHED状态，服务端收到这个应答后也进入ESTABLISHED状态，此时连接的建立完成！

——————————————————————
TCP连接的释放一共需要四步，因此称为『四次挥手』。

我们知道，TCP连接是双向的，因此在四次挥手中，前两次挥手用于断开一个方向的连接，后两次挥手用于断开另一方向的连接。

**第一次挥手**

若A认为数据发送完成，则它需要向B发送连接释放请求。该请求只有报文头，头中携带的主要参数为：FIN=1，seq=u。此时，A将进入FIN-WAIT-1状态。

-   PS1：FIN=1表示该报文段是一个连接释放请求。
    
-   PS2：seq=u，u-1是A向B发送的最后一个字节的序号。
    

**第二次挥手**

B收到连接释放请求后，会通知相应的应用程序，告诉它A向B这个方向的连接已经释放。此时B进入CLOSE-WAIT状态，并向A发送连接释放的应答，其报文头包含：ACK=1，seq=v，ack=u+1。

-   PS1：ACK=1：除TCP连接请求报文段以外，TCP通信过程中所有数据报的ACK都为1，表示应答。
    
-   PS2：seq=v，v-1是B向A发送的最后一个字节的序号。
    
-   PS3：ack=u+1表示希望收到从第u+1个字节开始的报文段，并且已经成功接收了前u个字节。
    

A收到该应答，进入FIN-WAIT-2状态，等待B发送连接释放请求。

第二次挥手完成后，A到B方向的连接已经释放，B不会再接收数据，A也不会再发送数据。但B到A方向的连接仍然存在，B可以继续向A发送数据。

**第三次挥手**

当B向A发完所有数据后，向A发送连接释放请求，请求头：FIN=1，ACK=1，seq=w，ack=u+1。B便进入LAST-ACK状态。

**第四次挥手**

A收到释放请求后，向B发送确认应答，此时A进入TIME-WAIT状态。该状态会持续2MSL时间，若该时间段内没有B的重发请求的话，就进入CLOSED状态，撤销TCB。当B收到确认应答后，也便进入CLOSED状态，撤销TCB。
—————————————————————————————————
TCP/IP协议是面向传输层的安全可靠的协议，三次握手的机制是为了保证一个安全可靠的连接。第一次握手是由客户端发起，客户端会发起一个报文，报文中SYN位会置为1，服务端收到报文后会发送一个确认消息报，确认消息包中会将ACK位置1。这时客户端是能收到服务端的消息，但服务端需要确认客户端是否能接收到消息，所以第三次握手是指客户端还需再想服务端回应，将报文的ACK位置为1，通知服务端能够接收到消息。

### 1.1为什么连接建立需要三次握手，而不是两次握手？

在《计算机网络》中的标准回答是：

防止已失效的连接请求又传送到服务器端，因而产生错误。

这种屁话写出来就不是让人看懂的。

稍微看懂的回答：
	> -   为了实现可靠数据传输， TCP 协议的通信双方， 都必须维护一个序列号， 以标识发送出去的数据包中， 哪些是已经被对方收到的。 三次握手的过程即是通信双方相互告知序列号起始值， 并确认对方已经收到了序列号起始值的必经步骤
	> -   如果只是两次握手， 至多只有连接发起方的起始序列号能被确认， 另一方选择的序列号则得不到确认

用个比喻来形容就是，打仗发电报：A想告诉B一个重要情报，这时候A发起一个报文，告诉他，我先试试能不能跟你通话（SYN=1），给你个数100（seq），你要是能收到你就告诉我一声，然后100+1。B这边收到后，会发送我已经收到了（ACK=1），给你101（ACK+1），你能收到我的话不（SYN = 1，seq=200）？这时候A收到后只要回复收到了（ACK=1），给你201（ACK+1）。
假如只有两次握手，A跟B说，你能收到我电报不（SYN=1），给你个数100（seq），你要是能收到就告诉我一声，然后100+1。对了，我肯定能收到你电报，你不用跟我俩多bb。B说，你咋那么nb呢，我XX你个XX。
